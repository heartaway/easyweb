<?xml version="1.0" encoding="GB2312"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">


<sqlMap>

	<typeAlias alias="Project" type="com.taobao.easyweb.project.Project" />
	<resultMap id="ProjectMap" class="Project">
		<result property="id" column="id" />
		<result property="name" column="name" />
		<result property="description" column="description" />
		<result property="parentId" column="parent_id" />
		<result property="creator" column="creator" />
		<result property="status" column="status" />
		<result property="shareType" column="share_type" />
		<result property="thumbnails" column="thumbnails" />
		
		<result property="endTime" column="end_time" jdbcType="DATETIME" />
		<result property="gmtCreate" column="GMT_CREATE" jdbcType="DATETIME" />
		<result property="gmtModified" column="GMT_MODIFIED" jdbcType="DATETIME" />
	</resultMap>

	<sql id="projectDAO.selectField">
		<![CDATA[
		SELECT id,name,description,parent_id,thumbnails,creator,status,share_type,end_time,GMT_CREATE,GMT_MODIFIED FROM ew_project
		]]>
	</sql>

	<select id="projectDAO.queryById" parameterClass="int" resultMap="ProjectMap">
		<include refid="projectDAO.selectField" />
		<![CDATA[
			where id = #id#
		]]>
	</select>
	

	<select id="projectDAO.queryUserProjects" resultMap="ProjectMap">
		<include refid="projectDAO.selectField" />
		<![CDATA[
			where user_id=#userId#
		]]>
	</select>
	<select id="projectDAO.queryProjects" resultMap="ProjectMap" parameterClass="list">
		<include refid="projectDAO.selectField" />
		<![CDATA[
			where id in
		]]>
		<iterate conjunction="," open="(" close=")" >
			#ids[]#
		</iterate>
	</select>
	<select id="projectDAO.queryAllProjects" resultMap="ProjectMap">
		<include refid="projectDAO.selectField" />
		<![CDATA[
			where share_type =0
		]]>
	</select>

	<update id="projectDAO.update" parameterClass="Project">
		<![CDATA[
        	update ew_project set gmt_modified=now()
	 	]]>
		<isNotNull prepend="," property="name">
			name = #name#
		</isNotNull>
		<isNotNull prepend="," property="description">
			description = #description#
		</isNotNull>
		<isNotNull prepend="," property="endTime">
			endTime = #endTime#
		</isNotNull>
		<isNotNull prepend="," property="status">
			status = #status#
		</isNotNull>
		<isNotNull prepend="," property="shareType">
			share_type = #shareType#
		</isNotNull>
		<isNotNull prepend="," property="thumbnails">
			thumbnails = #thumbnails#
		</isNotNull>
	 	<![CDATA[
	        WHERE ID = #id#
	 	]]>
	</update>

	<insert id="projectDAO.insert" parameterClass="Project">
	    <![CDATA[
        INSERT INTO ew_project
        ( 
          parent_id,
          name,
          status,
          description,
          creator,
          share_type,
          end_time,
          thumbnails,
          GMT_CREATE,
          GMT_MODIFIED
        ) VALUES (
          #parentId#,
          #name#,
          #status#,
          #description#,
          #creator#,
          #shareType#,
          #endTime#,
          #thumbnails#,
		  now(),
		  now()
        )
         ]]>
	</insert>

	<select id="projectDAO.queryChildrenProjects" parameterClass="int">
		<include refid="projectDAO.selectField" />
		<![CDATA[
			where parent_id = #id#
		]]>
	</select>
	
	<insert id="projectDAO.addUser" parameterClass="map">
		 <![CDATA[
        INSERT INTO ew_project_user
        ( project_id,  
          user_id,
          status,
          GMT_CREATE,
          GMT_MODIFIED
        ) VALUES (
          #projectId#,
          #userId#,
          0,
		  now(),
		  now()
        )
         ]]>
	</insert>
	
	<update id="projectDAO.removeUser" parameterClass="map">
		<![CDATA[
        	update ew_project_user set gmt_modified=now(),status=-1 where user_id=#userId# and project_id=#projectId#
	 	]]>
	</update>

</sqlMap>