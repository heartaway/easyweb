<?xml version="1.0" encoding="GB2312"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">


<sqlMap>

	<typeAlias alias="UserTask" type="com.taobao.easyweb.task.UserTask" />
	<resultMap id="UserTaskMap" class="UserTask">
		<result property="id" column="id" />
		<result property="userId" column="user_id" />
		<result property="taskId" column="task_id" />
		<result property="status" column="status" />
		<result property="endTime" column="end_time" jdbcType="DATETIME" />
		<result property="gmtCreate" column="GMT_CREATE" jdbcType="DATETIME" />
		<result property="gmtModified" column="GMT_MODIFIED" jdbcType="DATETIME" />
	</resultMap>

	<sql id="userTaskDAO.selectField">
		<![CDATA[
		SELECT id,user_id,task_id,status,end_time,GMT_CREATE,GMT_MODIFIED FROM ew_user_task
		]]>
	</sql>


	<select id="userTaskDAO.queryTaskUsers" parameterClass="int" resultClass="int">
		<![CDATA[
			select user_id from ew_user_task where task_id = #id#
		]]>
	</select>

	<select id="userTaskDAO.queryTasks" resultMap="UserTaskMap">
		<include refid="userTaskDAO.selectField" />
		<dynamic prepend="where">
			<isNotNull prepend="and" property="userId">
				user_id = #userId#
			</isNotNull>
			<isNotNull prepend="and" property="taskId">
				task_id = #taskId#
			</isNotNull>
			<isNotNull prepend="and" property="status">
				status = #status#
			</isNotNull>
			<isNotNull prepend="and" property="endTime">
				end_time = #endTime#
			</isNotNull>
			<isNotNull prepend="and" property="id">
				id = #id#
			</isNotNull>
		</dynamic>
		<![CDATA[
			order by GMT_MODIFIED desc
		]]>
	</select>

	<update id="userTaskDAO.update" parameterClass="UserTask">
		<![CDATA[
        	update ew_user_task set gmt_modified=now()
	 	]]>
		<isNotNull prepend="," property="endTime">
			end_time = #endTime#
		</isNotNull>
		<isNotNull prepend="," property="status">
			status = #status#
		</isNotNull>
	 	<![CDATA[
	        WHERE ID = #id#
	 	]]>
	</update>

	<insert id="userTaskDAO.insert" parameterClass="UserTask">
	    <![CDATA[
	        INSERT INTO ew_user_task
	        ( 
	          user_id,
	          status,
	          task_id,
	          end_time,
	          GMT_CREATE,
	          GMT_MODIFIED
	        ) VALUES (
	          #userId#,
	          #status#,
	          #taskId#,
	          #endTime#,
			  now(),
			  now()
	        )
        ]]>
	</insert>
	
	<delete id="userTaskDAO.delete" parameterClass="UserTask">
	    <![CDATA[
	        DELETE FROM ew_user_task
	        WHERE user_id=#userId# and task_id=#taskId#
	 	]]>
	</delete>

</sqlMap>