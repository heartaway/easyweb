<?xml version="1.0" encoding="GB2312"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">


<sqlMap>

	<typeAlias alias="Task" type="com.taobao.easyweb.task.Task" />
	<resultMap id="TaskMap" class="Task">
		<result property="id" column="id" />
		<result property="title" column="title" />
		<result property="description" column="description" />
		<result property="parentId" column="parent_id" />
		<result property="creator" column="creator" />
		<result property="status" column="status" />
		<result property="assignTo" column="assign_to" />
		<result property="outerBiz" column="outer_biz" />
		<result property="outerBizId" column="outer_biz_id" />
		<result property="endTime" column="end_time" jdbcType="DATETIME" />
		<result property="gmtCreate" column="GMT_CREATE" jdbcType="DATETIME" />
		<result property="gmtModified" column="GMT_MODIFIED" jdbcType="DATETIME" />
	</resultMap>

	<sql id="taskDAO.selectField">
		<![CDATA[
		SELECT id,title,description,parent_id,creator,status,assign_to,outer_biz,outer_biz_id,end_time,GMT_CREATE,GMT_MODIFIED FROM ew_task
		]]>
	</sql>

	<select id="taskDAO.queryById" parameterClass="int" resultMap="TaskMap">
		<include refid="taskDAO.selectField" />
		<![CDATA[
			where id = #id#
		]]>
	</select>
	
	<select id="taskDAO.queryTasks" resultMap="TaskMap">
		<include refid="taskDAO.selectField" />
		<dynamic prepend="where">
			<isNotNull prepend="and" property="parentId">
				parent_id = #parentId#
			</isNotNull>
			<isNotNull prepend="and" property="creator">
				creator = #creator#
			</isNotNull>
			<isNotNull prepend="and" property="outerBizId">
				outer_biz_id = #outerBizId#
			</isNotNull>
			<isNotNull prepend="and" property="status">
				status = #status#
			</isNotNull>
			<isNull prepend="and" property="status">
				status >= 0
			</isNull>
			<isNotNull prepend="and" property="outerBiz">
				outer_Biz = #outerBiz#
			</isNotNull>
			<isNotNull prepend="and" property="outerBizId">
				outer_biz_id = #outerBizId#
			</isNotNull>
			<isNotNull prepend="and" property="assignTo">
				assign_to = #assignTo#
			</isNotNull>
			<isNotNull prepend="and" property="id">
				id = #id#
			</isNotNull>
		</dynamic>
		<![CDATA[
			order by GMT_MODIFIED desc
		]]>
	</select>

	<update id="taskDAO.update" parameterClass="Task">
		<![CDATA[
        	update ew_task set gmt_modified=now()
	 	]]>
		<isNotNull prepend="," property="title">
			title = #title#
		</isNotNull>
		<isNotNull prepend="," property="description">
			description = #description#
		</isNotNull>
		<isNotNull prepend="," property="status">
			status = #status#
		</isNotNull>
		<isNotNull prepend="," property="assignTo">
			assign_to = #assignTo#
		</isNotNull>
		<isNotNull prepend="," property="endTime">
			end_time = #endTime#
		</isNotNull>
	 	<![CDATA[
	        WHERE ID = #id#
	 	]]>
	</update>

	<insert id="taskDAO.insert" parameterClass="Task">
	    <![CDATA[
        INSERT INTO ew_task
        ( 
          parent_id,
          status,
          title,
          description,
          creator,
          assign_to,
          end_time,
          outer_biz,
          outer_biz_id,
          GMT_CREATE,
          GMT_MODIFIED
        ) VALUES (
          #parentId#,
          #status#,
          #title#,
          #description#,
          #creator#,
          #assignTo#,
          #endTime#,
          #outerBiz#,
          #outerBizId#,
		  now(),
		  now()
        )
         ]]>
	</insert>


</sqlMap>